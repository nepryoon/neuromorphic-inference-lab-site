<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Forecast Studio | Neuromorphic Inference Lab</title>
  <meta name="description" content="Forecast Studio: explore lightweight forecasting locally and optionally call an API endpoint." />

  <style>
    :root{
      --bg:#070A12;--surface:rgba(255,255,255,.06);--surface2:rgba(255,255,255,.08);--border:rgba(255,255,255,.12);
      --text:rgba(255,255,255,.92);--muted:rgba(255,255,255,.68);
      --accent:#64FFDA;--accent2:#7C5CFF;--ok:#43FBA4;--warn:#FFCE57;--danger:#FF4D6D;
      --shadow:0 10px 30px rgba(0,0,0,.35);--radius:18px;--max:1100px;
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;font-family:var(--sans);color:var(--text);line-height:1.55;
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(124,92,255,.18), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(100,255,218,.14), transparent 55%),
        radial-gradient(700px 450px at 40% 80%, rgba(124,92,255,.12), transparent 60%),
        var(--bg);
    }
    a{color:inherit;text-decoration:none;}
    a:hover{text-decoration:underline;text-underline-offset:3px;}
    .wrap{max-width:var(--max);margin:0 auto;padding:20px 18px 46px;}

    header{
      position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);
      background:linear-gradient(to bottom, rgba(7,10,18,.82), rgba(7,10,18,.50));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .nav{max-width:var(--max);margin:0 auto;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:14px;}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.2px;}
    .logo{
      width:34px;height:34px;border-radius:10px;
      background:
        radial-gradient(circle at 30% 30%, rgba(100,255,218,.95), rgba(100,255,218,.15) 58%, transparent 60%),
        radial-gradient(circle at 70% 70%, rgba(124,92,255,.9), rgba(124,92,255,.18) 55%, transparent 57%),
        rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 8px 22px rgba(0,0,0,.25);
    }
    nav ul{list-style:none;display:flex;gap:10px;padding:0;margin:0;flex-wrap:wrap;justify-content:flex-end;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);color:var(--muted);font-size:14px;
    }
    .pill.active{color:var(--text);border-color:rgba(100,255,218,.35);background:rgba(100,255,218,.08);}

    .hero{
      margin-top:22px;padding:22px;border-radius:var(--radius);border:1px solid var(--border);
      background:linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);position:relative;overflow:hidden;
    }
    .hero:before{
      content:"";position:absolute;inset:-2px;
      background:
        radial-gradient(420px 260px at 10% 20%, rgba(100,255,218,.20), transparent 55%),
        radial-gradient(420px 260px at 90% 40%, rgba(124,92,255,.18), transparent 60%);
      pointer-events:none;filter:blur(1px);
    }
    .hero>*{position:relative;}
    h1{margin:0 0 8px;font-size:clamp(28px,4vw,42px);line-height:1.12;letter-spacing:.2px;}
    .subtitle{margin:0;color:var(--muted);max-width:92ch;}

    .rowWrap{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .btn{
      display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);
      color:var(--text);font-weight:600;font-size:14px;box-shadow:0 10px 20px rgba(0,0,0,.18);cursor:pointer;
    }
    .btn:hover{background:rgba(255,255,255,.08);text-decoration:none;}
    .btn.primary{
      border-color:rgba(100,255,218,.40);
      background:linear-gradient(135deg, rgba(100,255,218,.18), rgba(124,92,255,.12));
    }
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.10);box-shadow:none;}
    .btn:disabled{opacity:.6;cursor:not-allowed;}

    .kbd{
      font-family:var(--mono);font-size:12px;padding:2px 8px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);border-radius:999px;color:rgba(255,255,255,.78);
    }
    .badge{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);
      font-size:12px;color:rgba(255,255,255,.78);font-family:var(--mono);white-space:nowrap;
    }
    .badge.ok{border-color:rgba(67,251,164,.35);background:rgba(67,251,164,.10);color:rgba(255,255,255,.90);}
    .badge.bad{border-color:rgba(255,77,109,.35);background:rgba(255,77,109,.10);color:rgba(255,255,255,.90);}
    .badge.warn{border-color:rgba(255,206,87,.30);background:rgba(255,206,87,.10);color:rgba(255,255,255,.90);}

    .grid{margin-top:16px;display:grid;gap:12px;grid-template-columns:1.2fr .8fr;align-items:start;}
    @media (max-width:980px){.grid{grid-template-columns:1fr;}}
    .card{border-radius:var(--radius);border:1px solid var(--border);background:rgba(255,255,255,.05);box-shadow:0 10px 24px rgba(0,0,0,.22);padding:16px;}
    .card h2{margin:0 0 8px;font-size:18px;letter-spacing:.2px;}
    .muted{color:var(--muted);}
    .small{font-size:14px;}
    .mono{font-family:var(--mono);}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:14px 0;}

    label{font-size:13px;color:rgba(255,255,255,.82);font-weight:800;letter-spacing:.2px;}
    input, select, textarea{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 12px;
      outline:none;
      font-family:var(--sans);
    }
    textarea{min-height:110px;resize:vertical;}
    input:focus, select:focus, textarea:focus{
      border-color:rgba(100,255,218,.35);
      box-shadow:0 0 0 4px rgba(100,255,218,.08);
    }

    .formGrid{display:grid;gap:10px;grid-template-columns:1fr 1fr;}
    @media (max-width:700px){.formGrid{grid-template-columns:1fr;}}

    .samples{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.16);
      font-size:12px;color:rgba(255,255,255,.82);
      cursor:pointer;user-select:none;
    }
    .chip:hover{background:rgba(255,255,255,.06);}

    .toggle{
      display:inline-flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);padding:6px;border-radius:999px;
    }
    .toggle button{
      border:0;background:transparent;color:rgba(255,255,255,.75);
      padding:8px 10px;border-radius:999px;cursor:pointer;font-weight:800;font-size:12px;
    }
    .toggle button.active{
      color:rgba(255,255,255,.92);
      background:linear-gradient(135deg, rgba(100,255,218,.16), rgba(124,92,255,.12));
      border:1px solid rgba(100,255,218,.30);
    }

    canvas{
      width:100%;
      height:260px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      display:block;
    }

    pre{
      margin:10px 0 0;padding:12px;border-radius:14px;border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);overflow:auto;font-family:var(--mono);font-size:12px;color:rgba(255,255,255,.82);
    }

    footer{margin-top:24px;color:rgba(255,255,255,.55);font-size:13px;}
  </style>
</head>

<body>
<header>
  <div class="nav">
    <a class="brand" href="/" aria-label="Neuromorphic Inference Lab Home">
      <span class="logo" aria-hidden="true"></span>
      <span>Neuromorphic Inference Lab</span>
    </a>
    <nav aria-label="Main navigation">
      <ul>
        <li><a class="pill" href="/">Home</a></li>
        <li><a class="pill active" href="/demos/">Demos</a></li>
        <li><a class="pill" href="/evidence/">Evidence</a></li>
      </ul>
    </nav>
  </div>
</header>

<main class="wrap">
  <section class="hero">
    <h1>Forecast Studio</h1>
    <p class="subtitle">
      Explore a lightweight forecasting workflow. Local mode runs in the browser; API mode can call an optional endpoint.
    </p>

    <div class="rowWrap">
      <a class="btn primary" href="/evidence/#forecast-studio">Evidence anchor <span class="kbd">#forecast-studio</span></a>
      <a class="btn" href="https://github.com/nepryoon/nil-forecast-studio" target="_blank" rel="noopener noreferrer">GitHub</a>

      <span class="toggle" role="group" aria-label="Mode selector">
        <button id="modeLocal" class="active" type="button">Local</button>
        <button id="modeApi" type="button">API</button>
      </span>
      <span class="badge warn" id="bMode">mode: local</span>
      <span class="badge" id="bStatus">status: idle</span>
    </div>
  </section>

  <section class="grid">
    <div class="card">
      <h2>Try it</h2>
      <p class="muted small">
        Enter a numeric series (comma-separated). Local mode supports a simple baseline. API mode expects
        <span class="mono">POST /forecast/predict</span> (optional).
      </p>

      <div class="samples" aria-label="Sample series">
        <span class="chip" data-series="120,118,123,130,128,132,136,134,140,145,147,150">Trend</span>
        <span class="chip" data-series="50,54,58,62,61,59,55,52,49,50,53,57,61">Seasonal-ish</span>
        <span class="chip" data-series="80,79,81,78,82,83,81,80,79,81,82,84">Stable</span>
      </div>

      <div class="divider"></div>

      <div style="display:grid;gap:10px;">
        <div>
          <label for="series">Series</label>
          <textarea id="series" placeholder="e.g. 120,118,123,130,128"></textarea>
        </div>

        <div class="formGrid">
          <div>
            <label for="method">Method</label>
            <select id="method">
              <option value="moving_average" selected>Moving average</option>
              <option value="naive">Naïve (last value)</option>
            </select>
          </div>
          <div>
            <label for="horizon">Horizon</label>
            <input id="horizon" type="number" min="1" max="60" value="7" />
          </div>
          <div>
            <label for="window">Window</label>
            <input id="window" type="number" min="1" max="60" value="3" />
          </div>
          <div>
            <label for="holdout">Holdout (for metrics)</label>
            <input id="holdout" type="number" min="1" max="60" value="4" />
          </div>
        </div>

        <div class="rowWrap" style="margin-top:0;">
          <button class="btn primary" id="btnRun" type="button">Run</button>
          <button class="btn" id="btnClear" type="button">Clear</button>
          <span class="badge" id="bMetrics">metrics: —</span>
        </div>
      </div>

      <div class="divider"></div>

      <h2>Chart</h2>
      <canvas id="chart" width="900" height="360" aria-label="Series chart"></canvas>

      <div class="divider"></div>

      <h2>Output</h2>
      <pre id="out">{}</pre>
    </div>

    <aside class="card">
      <h2>Links</h2>
      <div class="small" style="display:grid;gap:10px;">
        <a class="btn" style="justify-content:space-between;" href="/evidence/#forecast-studio"><span>Evidence</span><span class="kbd">#forecast-studio</span></a>
        <a class="btn" style="justify-content:space-between;" href="https://github.com/nepryoon/nil-forecast-studio" target="_blank" rel="noopener noreferrer"><span>Repository</span><span class="kbd">GitHub</span></a>
        <a class="btn" style="justify-content:space-between;" href="/evidence/#sql"><span>Related</span><span class="kbd">#sql</span></a>
      </div>

      <div class="divider"></div>

      <h2>API contract (optional)</h2>
      <pre>{
  "series": [120, 118, 123, 130],
  "horizon": 7,
  "window": 3,
  "method": "moving_average|naive"
}</pre>

      <pre>{
  "forecast": [131.3, 132.0, 132.4],
  "meta": { "latency_ms": 35, "version": "0.0.x", "git_sha": "..." }
}</pre>

      <p class="muted small" style="margin:10px 0 0;">
        If API mode fails, local mode remains available.
      </p>
    </aside>
  </section>

  <footer>© <span id="year"></span> Neuromorphic Inference Lab — Forecast Studio</footer>
</main>

<script>
  const API_BASE = "https://api.neuromorphicinference.com";

  const el = {
    year: document.getElementById("year"),
    series: document.getElementById("series"),
    method: document.getElementById("method"),
    horizon: document.getElementById("horizon"),
    window: document.getElementById("window"),
    holdout: document.getElementById("holdout"),
    btnRun: document.getElementById("btnRun"),
    btnClear: document.getElementById("btnClear"),
    out: document.getElementById("out"),
    chart: document.getElementById("chart"),
    bStatus: document.getElementById("bStatus"),
    bMode: document.getElementById("bMode"),
    bMetrics: document.getElementById("bMetrics"),
    modeLocal: document.getElementById("modeLocal"),
    modeApi: document.getElementById("modeApi"),
  };

  el.year.textContent = new Date().getFullYear();

  let mode = "local";

  function setMode(next) {
    mode = next;
    el.modeLocal.classList.toggle("active", mode === "local");
    el.modeApi.classList.toggle("active", mode === "api");
    el.bMode.textContent = `mode: ${mode}`;
    el.bMode.classList.remove("ok","bad","warn");
    el.bMode.classList.add("warn");
  }

  function setBadge(text, state) {
    el.bStatus.textContent = text;
    el.bStatus.classList.remove("ok","bad","warn");
    if (state) el.bStatus.classList.add(state);
  }

  function parseSeries(text) {
    const raw = text.split(",").map(s => s.trim()).filter(Boolean);
    const nums = raw.map(x => Number(x));
    if (!nums.length) return { ok: false, error: "Please provide at least one number." };
    if (nums.some(n => !Number.isFinite(n))) return { ok: false, error: "Series contains non-numeric values." };
    return { ok: true, series: nums };
  }

  function movingAverageForecast(series, horizon, window) {
    const out = [];
    const buf = series.slice();
    for (let i = 0; i < horizon; i++) {
      const w = Math.max(1, Math.min(window, buf.length));
      const tail = buf.slice(buf.length - w);
      const avg = tail.reduce((a,b) => a + b, 0) / w;
      out.push(avg);
      buf.push(avg);
    }
    return out;
  }

  function naiveForecast(series, horizon) {
    const last = series[series.length - 1];
    return Array.from({ length: horizon }, () => last);
  }

  function metrics(yTrue, yPred) {
    const n = Math.min(yTrue.length, yPred.length);
    if (n <= 0) return null;
    let mae = 0, mse = 0, mape = 0, mapeCount = 0;
    for (let i = 0; i < n; i++) {
      const e = yTrue[i] - yPred[i];
      mae += Math.abs(e);
      mse += e * e;
      if (yTrue[i] !== 0) { mape += Math.abs(e / yTrue[i]); mapeCount++; }
    }
    mae /= n;
    const rmse = Math.sqrt(mse / n);
    const mapePct = mapeCount ? (mape / mapeCount) * 100 : null;
    return { mae, rmse, mape_pct: mapePct };
  }

  function drawChart(series, forecast) {
    const ctx = el.chart.getContext("2d");
    const W = el.chart.width, H = el.chart.height;
    ctx.clearRect(0, 0, W, H);

    // background
    ctx.fillStyle = "rgba(0,0,0,.14)";
    ctx.fillRect(0,0,W,H);

    const all = series.concat(forecast || []);
    const min = Math.min(...all);
    const max = Math.max(...all);
    const pad = 36;

    const xScale = (i) => {
      const n = Math.max(2, all.length);
      return pad + (i * (W - pad*2) / (n - 1));
    };
    const yScale = (v) => {
      const denom = (max - min) || 1;
      return (H - pad) - ((v - min) * (H - pad*2) / denom);
    };

    // axes
    ctx.strokeStyle = "rgba(255,255,255,.10)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(pad, pad);
    ctx.lineTo(pad, H - pad);
    ctx.lineTo(W - pad, H - pad);
    ctx.stroke();

    // series line
    ctx.strokeStyle = "rgba(100,255,218,.85)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    series.forEach((v, i) => {
      const x = xScale(i);
      const y = yScale(v);
      if (i === 0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    });
    ctx.stroke();

    // forecast line
    if (forecast && forecast.length) {
      const offset = series.length - 1;
      ctx.strokeStyle = "rgba(124,92,255,.85)";
      ctx.setLineDash([6,4]);
      ctx.lineWidth = 2;
      ctx.beginPath();
      forecast.forEach((v, i) => {
        const idx = offset + i;
        const x = xScale(idx);
        const y = yScale(v);
        if (i === 0) ctx.moveTo(xScale(offset), yScale(series[series.length - 1]));
        ctx.lineTo(x,y);
      });
      ctx.stroke();
      ctx.setLineDash([]);
    }

    // label
    ctx.fillStyle = "rgba(255,255,255,.70)";
    ctx.font = "12px " + getComputedStyle(document.documentElement).getPropertyValue("--mono");
    ctx.fillText("series", pad + 6, pad + 14);
    ctx.fillStyle = "rgba(255,255,255,.55)";
    ctx.fillText("forecast", pad + 6, pad + 30);
  }

  async function fetchWithTimeout(url, opts = {}, ms = 12000) {
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), ms);
    try {
      const res = await fetch(url, {
        ...opts,
        signal: ctrl.signal,
        headers: { "Accept":"application/json", ...(opts.headers || {}) }
      });
      clearTimeout(t);
      return res;
    } catch (e) {
      clearTimeout(t);
      throw e;
    }
  }

  async function run() {
    const parsed = parseSeries(el.series.value || "");
    if (!parsed.ok) {
      setBadge("status: invalid input", "warn");
      el.out.textContent = JSON.stringify({ error: parsed.error }, null, 2);
      return;
    }

    const horizon = Math.max(1, Math.min(60, Number(el.horizon.value || 7)));
    const window = Math.max(1, Math.min(60, Number(el.window.value || 3)));
    const holdout = Math.max(1, Math.min(60, Number(el.holdout.value || 4)));
    const method = el.method.value;

    const series = parsed.series;

    setBadge("status: running…", "warn");
    el.btnRun.disabled = true;

    try {
      const t0 = performance.now();
      let result;

      if (mode === "local") {
        const train = series.slice(0, Math.max(0, series.length - holdout));
        const test = series.slice(Math.max(0, series.length - holdout));

        if (train.length < 2) {
          throw new Error("Not enough points for holdout. Reduce holdout or add more points.");
        }

        let forecast;
        if (method === "naive") forecast = naiveForecast(series, horizon);
        else forecast = movingAverageForecast(series, horizon, window);

        // one-step baseline for holdout evaluation
        const predHoldout = [];
        const buf = train.slice();
        for (let i = 0; i < test.length; i++) {
          let p = (method === "naive")
            ? buf[buf.length - 1]
            : movingAverageForecast(buf, 1, window)[0];
          predHoldout.push(p);
          buf.push(test[i]);
        }

        const m = metrics(test, predHoldout);
        const meta = {
          mode: "local",
          method,
          horizon,
          window,
          holdout,
        };

        result = { series, forecast, evaluation: { test, pred: predHoldout, metrics: m }, meta };
      } else {
        const payload = { series, horizon, window, method };
        const r = await fetchWithTimeout(`${API_BASE}/forecast/predict`, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        const text = await r.text();
        const data = (() => { try { return JSON.parse(text); } catch { return { raw: text }; } })();
        if (!r.ok) throw new Error(`API error (HTTP ${r.status}): ${data?.detail || text}`);
        result = { mode: "api", request: payload, response: data };
      }

      const t1 = performance.now();
      const latency = Math.round(t1 - t0);

      // render
      if (mode === "local") {
        drawChart(result.series, result.forecast);
        const m = result?.evaluation?.metrics;
        if (m) {
          const mae = m.mae.toFixed(2);
          const rmse = m.rmse.toFixed(2);
          const mape = (m.mape_pct == null) ? "n/a" : m.mape_pct.toFixed(1) + "%";
          el.bMetrics.textContent = `metrics: MAE=${mae} | RMSE=${rmse} | MAPE=${mape}`;
        } else {
          el.bMetrics.textContent = "metrics: —";
        }
      } else {
        const f = Array.isArray(result?.response?.forecast) ? result.response.forecast : [];
        drawChart(series, f);
        el.bMetrics.textContent = "metrics: —";
      }

      result.latency_ms = latency;
      el.out.textContent = JSON.stringify(result, null, 2);
      setBadge("status: done", "ok");
    } catch (e) {
      el.out.textContent = JSON.stringify({ error: String(e?.message || e) }, null, 2);
      setBadge("status: error", "bad");
    } finally {
      el.btnRun.disabled = false;
    }
  }

  function clearAll() {
    el.series.value = "";
    el.out.textContent = "{}";
    el.bMetrics.textContent = "metrics: —";
    drawChart([], []);
    setBadge("status: idle", null);
  }

  document.querySelectorAll(".chip").forEach(ch => {
    ch.addEventListener("click", () => {
      el.series.value = ch.getAttribute("data-series") || "";
      setBadge("status: sample loaded", null);
    });
  });

  el.modeLocal.addEventListener("click", () => setMode("local"));
  el.modeApi.addEventListener("click", () => setMode("api"));

  el.btnRun.addEventListener("click", run);
  el.btnClear.addEventListener("click", clearAll);

  // initial
  drawChart([], []);
</script>
</body>
</html>
