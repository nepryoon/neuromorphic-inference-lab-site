<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Forecast Studio | Neuromorphic Inference Lab</title>
  <meta name="description" content="Forecast Studio: paste a series, run a local forecast, and optionally call an API endpoint." />

  <style>
    :root{
      --bg:#070A12;--border:rgba(255,255,255,.12);--text:rgba(255,255,255,.92);--muted:rgba(255,255,255,.68);
      --accent:#64FFDA;--accent2:#7C5CFF;--ok:#43FBA4;--warn:#FFCE57;--danger:#FF4D6D;
      --shadow:0 10px 30px rgba(0,0,0,.35);--radius:18px;--max:1100px;
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      --sans:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box;}
    body{
      margin:0;font-family:var(--sans);color:var(--text);line-height:1.55;
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(124,92,255,.18), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(100,255,218,.14), transparent 55%),
        radial-gradient(700px 450px at 40% 80%, rgba(124,92,255,.12), transparent 60%),
        var(--bg);
    }
    a{color:inherit;text-decoration:none;}
    a:hover{text-decoration:underline;text-underline-offset:3px;}
    .wrap{max-width:var(--max);margin:0 auto;padding:20px 18px 46px;}

    header{
      position:sticky;top:0;z-index:10;backdrop-filter:blur(10px);
      background:linear-gradient(to bottom, rgba(7,10,18,.82), rgba(7,10,18,.50));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .nav{max-width:var(--max);margin:0 auto;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;gap:14px;}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700;letter-spacing:.2px;}
    .logo{
      width:34px;height:34px;border-radius:10px;
      background:
        radial-gradient(circle at 30% 30%, rgba(100,255,218,.95), rgba(100,255,218,.15) 58%, transparent 60%),
        radial-gradient(circle at 70% 70%, rgba(124,92,255,.9), rgba(124,92,255,.18) 55%, transparent 57%),
        rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 8px 22px rgba(0,0,0,.25);
    }
    nav ul{list-style:none;display:flex;gap:10px;padding:0;margin:0;flex-wrap:wrap;justify-content:flex-end;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);color:var(--muted);font-size:14px;
    }
    .pill.active{color:var(--text);border-color:rgba(100,255,218,.35);background:rgba(100,255,218,.08);}

    .hero{
      margin-top:22px;padding:22px;border-radius:var(--radius);border:1px solid var(--border);
      background:linear-gradient(135deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow:var(--shadow);position:relative;overflow:hidden;
    }
    .hero:before{
      content:"";position:absolute;inset:-2px;
      background:
        radial-gradient(420px 260px at 10% 20%, rgba(100,255,218,.20), transparent 55%),
        radial-gradient(420px 260px at 90% 40%, rgba(124,92,255,.18), transparent 60%);
      pointer-events:none;filter:blur(1px);
    }
    .hero>*{position:relative;}
    h1{margin:0 0 8px;font-size:clamp(28px,4vw,42px);line-height:1.12;letter-spacing:.2px;}
    .subtitle{margin:0;color:var(--muted);max-width:92ch;}

    .rowWrap{margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .btn{
      display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);
      color:var(--text);font-weight:600;font-size:14px;box-shadow:0 10px 20px rgba(0,0,0,.18);cursor:pointer;
    }
    .btn:hover{background:rgba(255,255,255,.08);text-decoration:none;}
    .btn.primary{
      border-color:rgba(100,255,218,.40);
      background:linear-gradient(135deg, rgba(100,255,218,.18), rgba(124,92,255,.12));
    }
    .btn:disabled{opacity:.6;cursor:not-allowed;}

    .toggle{
      display:inline-flex;gap:8px;align-items:center;border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.18);padding:6px;border-radius:999px;
    }
    .toggle button{
      border:0;background:transparent;color:rgba(255,255,255,.75);
      padding:8px 10px;border-radius:999px;cursor:pointer;font-weight:700;font-size:12px;
    }
    .toggle button.active{
      color:rgba(255,255,255,.92);
      background:linear-gradient(135deg, rgba(100,255,218,.16), rgba(124,92,255,.12));
      border:1px solid rgba(100,255,218,.30);
    }

    .badge{
      display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);
      font-size:12px;color:rgba(255,255,255,.78);font-family:var(--mono);white-space:nowrap;
    }
    .badge.ok{border-color:rgba(67,251,164,.35);background:rgba(67,251,164,.10);color:rgba(255,255,255,.90);}
    .badge.bad{border-color:rgba(255,77,109,.35);background:rgba(255,77,109,.10);color:rgba(255,255,255,.90);}
    .badge.warn{border-color:rgba(255,206,87,.30);background:rgba(255,206,87,.10);color:rgba(255,255,255,.90);}
    .kbd{
      font-family:var(--mono);font-size:12px;padding:2px 8px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);border-radius:999px;color:rgba(255,255,255,.78);
    }

    .grid{margin-top:16px;display:grid;gap:12px;grid-template-columns:1.15fr .85fr;align-items:start;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }
    .card{border-radius:var(--radius);border:1px solid var(--border);background:rgba(255,255,255,.05);box-shadow:0 10px 24px rgba(0,0,0,.22);padding:16px;}
    .card h2{margin:0 0 8px;font-size:18px;letter-spacing:.2px;}
    .muted{color:var(--muted);}
    .small{font-size:14px;}
    .mono{font-family:var(--mono);}
    .divider{height:1px;background:rgba(255,255,255,.08);margin:14px 0;}

    textarea{
      width:100%;
      min-height:130px;
      resize:vertical;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      color:var(--text);
      padding:12px 12px;
      font-family:var(--mono);
      font-size:12px;
      outline:none;
    }
    textarea:focus{
      border-color:rgba(100,255,218,.35);
      box-shadow:0 0 0 4px rgba(100,255,218,.08);
    }

    .controls{
      display:grid;
      grid-template-columns:repeat(3, minmax(0, 1fr));
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 820px){ .controls{grid-template-columns:1fr;} }

    select, input[type="number"]{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
      font-family:var(--sans);
    }

    .plot{
      margin-top:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      padding:12px;
      overflow:hidden;
    }
    pre{
      margin:10px 0 0;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
      overflow:auto;
      font-family:var(--mono);
      font-size:12px;
      color:rgba(255,255,255,.82);
    }
    footer{margin-top:24px;color:rgba(255,255,255,.55);font-size:13px;}
  </style>
</head>

<body>
<header>
  <div class="nav">
    <a class="brand" href="/" aria-label="Neuromorphic Inference Lab Home">
      <span class="logo" aria-hidden="true"></span>
      <span>Neuromorphic Inference Lab</span>
    </a>
    <nav aria-label="Main navigation">
      <ul>
        <li><a class="pill" href="/demos/">Demos</a></li>
        <li><a class="pill" href="/evidence/">Evidence</a></li>
      </ul>
    </nav>
  </div>
</header>

<main class="wrap">
  <section class="hero">
    <h1>Forecast Studio</h1>
    <p class="subtitle">
      Paste a numeric series and generate a short-horizon forecast. Local methods run in the browser; API mode is optional.
    </p>

    <div class="rowWrap">
      <a class="btn primary" href="/evidence/#forecast-studio">Evidence <span class="kbd">#forecast-studio</span></a>
      <a class="btn" href="https://github.com/nepryoon/nil-forecast-studio" target="_blank" rel="noopener noreferrer">GitHub</a>

      <span class="toggle" role="group" aria-label="Mode selector">
        <button id="modeLocal" class="active" type="button">Local</button>
        <button id="modeApi" type="button">API</button>
      </span>
      <span class="badge warn" id="bMode">mode: local</span>
      <span class="badge" id="bStatus">status: idle</span>
    </div>
  </section>

  <section class="grid">
    <div class="card">
      <h2>Try it</h2>
      <p class="muted small">
        Input format: one number per line, or comma-separated values. API mode expects <span class="mono">POST /forecast/predict</span> (optional).
      </p>

      <textarea id="series" aria-label="Time series input">120
118
121
125
124
128
130
129
133
136
135
139</textarea>

      <div class="controls" aria-label="Parameters">
        <div>
          <label class="small" style="color:rgba(255,255,255,.82);font-weight:700;">Method</label>
          <select id="method">
            <option value="moving-average">Moving average</option>
            <option value="exp-smoothing">Exponential smoothing</option>
          </select>
        </div>

        <div>
          <label class="small" style="color:rgba(255,255,255,.82);font-weight:700;">Horizon</label>
          <input id="horizon" type="number" min="1" max="24" step="1" value="6" />
        </div>

        <div>
          <label class="small" style="color:rgba(255,255,255,.82);font-weight:700;">Window / Alpha</label>
          <input id="param" type="number" min="1" max="12" step="1" value="3" />
        </div>
      </div>

      <div class="rowWrap" style="margin-top:12px;">
        <button class="btn primary" id="btnRun" type="button">Forecast</button>
        <button class="btn" id="btnClear" type="button">Reset</button>
        <span class="badge" id="bMetric">MAE: —</span>
      </div>

      <div class="plot" id="plot" aria-label="Series plot"></div>

      <div class="divider"></div>
      <h2>Output</h2>
      <pre id="out">{}</pre>

      <div class="divider"></div>
      <h2>API schema (optional)</h2>
      <pre>{
  "series": [120,118,121,125],
  "horizon": 6,
  "method": "moving-average",
  "param": 3
}</pre>
    </div>

    <aside class="card">
      <h2>Links</h2>
      <div class="small" style="display:grid;gap:10px;">
        <a class="btn" style="justify-content:space-between;" href="/evidence/#forecast-studio"><span>Evidence</span><span class="kbd">#forecast-studio</span></a>
        <a class="btn" style="justify-content:space-between;" href="/evidence/#ml"><span>Related</span><span class="kbd">#ml</span></a>
        <a class="btn" style="justify-content:space-between;" href="/evidence/#sql"><span>Related</span><span class="kbd">#sql</span></a>
        <a class="btn" style="justify-content:space-between;" href="https://github.com/nepryoon/nil-forecast-studio" target="_blank" rel="noopener noreferrer"><span>Repository</span><span class="kbd">GitHub</span></a>
      </div>

      <div class="divider"></div>

      <h2>Notes</h2>
      <p class="muted small" style="margin:0;">
        The page runs a small back-test (hold-out) to compute MAE. The forecast is intentionally lightweight and deterministic.
      </p>
    </aside>
  </section>

  <footer>© <span id="year"></span> Neuromorphic Inference Lab — Forecast Studio</footer>
</main>

<script>
  const API_BASE = "https://api.neuromorphicinference.com";

  const el = {
    year: document.getElementById("year"),
    modeLocal: document.getElementById("modeLocal"),
    modeApi: document.getElementById("modeApi"),
    bMode: document.getElementById("bMode"),
    bStatus: document.getElementById("bStatus"),
    bMetric: document.getElementById("bMetric"),
    series: document.getElementById("series"),
    method: document.getElementById("method"),
    horizon: document.getElementById("horizon"),
    param: document.getElementById("param"),
    btnRun: document.getElementById("btnRun"),
    btnClear: document.getElementById("btnClear"),
    out: document.getElementById("out"),
    plot: document.getElementById("plot"),
  };

  el.year.textContent = new Date().getFullYear();

  let mode = "local";

  function setMode(next) {
    mode = next;
    el.modeLocal.classList.toggle("active", mode === "local");
    el.modeApi.classList.toggle("active", mode === "api");
    el.bMode.textContent = `mode: ${mode}`;
    el.bMode.classList.remove("ok","bad","warn");
    el.bMode.classList.add("warn");
  }

  function setStatus(text, state) {
    el.bStatus.textContent = text;
    el.bStatus.classList.remove("ok","bad","warn");
    if (state) el.bStatus.classList.add(state);
  }

  function parseSeries(text) {
    const parts = text
      .split(/[\n,]+/g)
      .map(s => s.trim())
      .filter(Boolean);

    const xs = parts.map(p => Number(p)).filter(n => Number.isFinite(n));
    return xs;
  }

  function mean(arr) {
    if (!arr.length) return 0;
    return arr.reduce((a,b) => a+b, 0) / arr.length;
  }

  function mae(yTrue, yPred) {
    if (!yTrue.length || yTrue.length !== yPred.length) return null;
    const e = yTrue.map((v,i) => Math.abs(v - yPred[i]));
    return mean(e);
  }

  function movingAverageForecast(series, horizon, window) {
    const w = Math.max(1, Math.floor(window));
    const forecasts = [];
    const history = series.slice();
    for (let i = 0; i < horizon; i++) {
      const tail = history.slice(-w);
      const f = mean(tail);
      forecasts.push(f);
      history.push(f);
    }
    return forecasts;
  }

  function expSmoothingForecast(series, horizon, alpha) {
    const a = Math.max(0.01, Math.min(0.99, alpha));
    let level = series[0];
    for (let i = 1; i < series.length; i++) {
      level = a * series[i] + (1 - a) * level;
    }
    // Flat forecast on the level
    return Array.from({ length: horizon }, () => level);
  }

  function backtest(series, method, param) {
    // Hold out last k points (min 3, max 6)
    const k = Math.min(6, Math.max(3, Math.floor(series.length / 4)));
    if (series.length < k + 4) return { mae: null, yTrue: [], yPred: [] };

    const train = series.slice(0, -k);
    const yTrue = series.slice(-k);

    let yPred;
    if (method === "moving-average") {
      const w = Math.max(1, Math.floor(param));
      yPred = movingAverageForecast(train, k, w);
    } else {
      const a = param;
      yPred = expSmoothingForecast(train, k, a);
    }

    return { mae: mae(yTrue, yPred), yTrue, yPred };
  }

  function renderPlot(series, forecast) {
    // Minimal inline SVG
    const all = series.concat(forecast || []);
    if (all.length < 2) {
      el.plot.innerHTML = `<div class="muted small">Not enough data to plot.</div>`;
      return;
    }

    const w = 860, h = 240, pad = 18;
    const minY = Math.min(...all);
    const maxY = Math.max(...all);
    const span = (maxY - minY) || 1;

    const toX = (i, n) => pad + (i * (w - 2*pad)) / (n - 1);
    const toY = (v) => pad + (h - 2*pad) * (1 - (v - minY) / span);

    const n1 = series.length;
    const n2 = all.length;

    const pathSeries = series.map((v,i) => `${i===0?"M":"L"} ${toX(i, n2)} ${toY(v)}`).join(" ");
    const pathForecast = (forecast && forecast.length)
      ? forecast.map((v,j) => {
          const i = n1 - 1 + (j+1);
          return `${j===0?"M":"L"} ${toX(n1-1, n2)} ${toY(series[n1-1])} L ${toX(i, n2)} ${toY(v)}`;
        }).slice(-1)[0]
      : "";

    const forecastPoints = (forecast || []).map((v,j) => {
      const i = n1 + j;
      return `<circle cx="${toX(i, n2)}" cy="${toY(v)}" r="3" fill="rgba(100,255,218,.95)"></circle>`;
    }).join("");

    el.plot.innerHTML = `
      <svg viewBox="0 0 ${w} ${h}" width="100%" height="auto" role="img" aria-label="Series and forecast plot">
        <defs>
          <linearGradient id="g1" x1="0" x2="1">
            <stop offset="0" stop-color="rgba(124,92,255,.95)"/>
            <stop offset="1" stop-color="rgba(45,212,191,.95)"/>
          </linearGradient>
        </defs>

        <rect x="0" y="0" width="${w}" height="${h}" rx="14" fill="rgba(0,0,0,.10)" stroke="rgba(255,255,255,.08)"></rect>

        <path d="${pathSeries}" fill="none" stroke="url(#g1)" stroke-width="2.4"></path>

        ${forecast && forecast.length ? `
          <path d="M ${toX(n1-1, n2)} ${toY(series[n1-1])} ${forecast.map((v,j)=>`L ${toX(n1+j, n2)} ${toY(v)}`).join(" ")}"
            fill="none" stroke="rgba(100,255,218,.90)" stroke-width="2.2" stroke-dasharray="6 6"></path>
          ${forecastPoints}
        ` : ""}

        <line x1="${toX(n1-1, n2)}" y1="${pad}" x2="${toX(n1-1, n2)}" y2="${h-pad}" stroke="rgba(255,255,255,.10)"></line>
      </svg>
    `;
  }

  async function fetchWithTimeout(url, opts = {}, ms = 12000) {
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), ms);
    try {
      const res = await fetch(url, {
        ...opts,
        signal: ctrl.signal,
        headers: { "Accept":"application/json", ...(opts.headers || {}) }
      });
      clearTimeout(t);
      return res;
    } catch (e) {
      clearTimeout(t);
      throw e;
    }
  }

  async function runForecast() {
    setStatus("status: running…", "warn");
    el.btnRun.disabled = true;

    try {
      const t0 = performance.now();
      const series = parseSeries(el.series.value);
      if (series.length < 4) throw new Error("Please provide at least 4 numeric points.");

      const method = el.method.value;
      const horizon = Math.max(1, Math.min(24, Math.floor(Number(el.horizon.value))));
      const rawParam = Number(el.param.value);

      let forecast = [];
      let result = {};

      if (mode === "local") {
        if (method === "moving-average") {
          const window = Math.max(1, Math.min(12, Math.floor(rawParam || 3)));
          forecast = movingAverageForecast(series, horizon, window);
          result.params = { method, horizon, param: window };
        } else {
          // Treat param as alpha. If user entered an integer, map to alpha.
          const alpha = (rawParam >= 1) ? Math.min(0.95, Math.max(0.05, rawParam / 10)) : Math.min(0.95, Math.max(0.05, rawParam || 0.35));
          forecast = expSmoothingForecast(series, horizon, alpha);
          result.params = { method, horizon, param: Number(alpha.toFixed(2)) };
        }

        const bt = backtest(series, method, result.params.param);
        const metric = bt.mae != null ? Number(bt.mae.toFixed(3)) : null;

        result = {
          mode: "local",
          input: { series, n: series.length },
          output: { forecast: forecast.map(v => Number(v.toFixed(3))) },
          backtest: metric != null ? { mae: metric } : { mae: null }
        };

        el.bMetric.textContent = `MAE: ${metric != null ? metric : "n/a"}`;
      } else {
        const payload = { series, horizon, method, param: rawParam };
        const r = await fetchWithTimeout(`${API_BASE}/forecast/predict`, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        const text = await r.text();
        const data = (() =>
