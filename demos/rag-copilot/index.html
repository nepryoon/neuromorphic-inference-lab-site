<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RAG Knowledge Copilot — Neuromorphic Inference Lab</title>
  <meta name="description" content="RAG Knowledge Copilot: retrieval tracing, grounded drafting, guardrails, and evaluation mindset — a Cloudflare-safe, client-only LLMOps demo." />
  <link rel="icon" href="/favicon.svg" />
  <link rel="stylesheet" href="/style.css" />

  <style>
    /* Minimal page-specific styles, consistent with site language */
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .muted { color: rgba(234,240,255,.74); }
    .tiny { font-size: 12px; line-height: 1.55; color: rgba(234,240,255,.72); }
    .row { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
    .stack { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 980px){ .stack { grid-template-columns: 1.25fr .75fr; } }
    .field { display: grid; gap: 8px; }
    .input, .textarea, .select {
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color: rgba(234,240,255,.92);
      padding: 12px 12px;
      outline: none;
    }
    .textarea { min-height: 120px; resize: vertical; }
    .input::placeholder, .textarea::placeholder { color: rgba(234,240,255,.45); }
    .panel {
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 18px;
      padding: 14px;
    }
    .policy {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    .policy label {
      display: flex;
      gap: 10px;
      align-items: flex-start;
      padding: 10px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      cursor: pointer;
    }
    .policy input { margin-top: 3px; }
    .hr { border: 0; border-top: 1px solid rgba(255,255,255,.10); margin: 12px 0; }
    details.trace > summary {
      cursor: pointer;
      list-style: none;
      user-select: none;
      font-weight: 600;
    }
    details.trace > summary::-webkit-details-marker { display: none; }
    .traceList { display: grid; gap: 10px; margin-top: 10px; }
    .hit {
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 10px;
    }
    .hitTop {
      display: flex; justify-content: space-between; gap: 10px; flex-wrap: wrap;
      align-items: baseline;
    }
    .scoreBar {
      width: 160px;
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      overflow: hidden;
    }
    .scoreFill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, rgba(88,211,255,.75), rgba(161,120,255,.75));
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      padding: 2px 7px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: rgba(234,240,255,.88);
    }
    .toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 18px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.55);
      color: rgba(234,240,255,.92);
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s ease;
      max-width: min(560px, 92vw);
    }
    .toast.show { opacity: 1; }
  </style>
</head>

<body>
  <header class="nav">
    <div class="inner">
      <div class="brand">
        <img src="/logo.svg" alt="Neuromorphic Inference Lab" />
        <span>Neuromorphic Inference Lab</span>
      </div>
      <nav class="navlinks" aria-label="Primary navigation">
        <a data-nav href="/">Signal</a>
        <a data-nav class="active" href="/demos/">Systems</a>
        <a data-nav href="/evidence/">Proof Ledger</a>
        <a data-nav href="/about/">Identity</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <p class="kicker">System</p>
      <h1 class="h1">RAG Knowledge Copilot</h1>
      <p class="sub">
        A client-only RAG demo that surfaces production signals: <strong>retrieval tracing</strong>, <strong>grounded drafting</strong>,
        <strong>guardrails</strong>, and an <strong>evaluation mindset</strong>. Designed to be reliable on Cloudflare Pages
        (no backend calls, no CORS failure modes).
      </p>

      <div class="badges">
        <span class="badge">RAG</span>
        <span class="badge">LLMOps</span>
        <span class="badge">Retrieval Tracing</span>
        <span class="badge">Guardrails</span>
        <span class="badge">Evaluation Harness</span>
      </div>

      <div style="height:12px"></div>

      <!-- Breadcrumb -->
      <div class="tags" aria-label="Breadcrumb">
        <a class="tag" href="/">Signal</a>
        <span class="tag">→</span>
        <a class="tag" href="/demos/">Systems</a>
        <span class="tag">→</span>
        <a class="tag" href="/evidence/">Proof Ledger</a>
        <span class="tag">→</span>
        <a class="tag" href="/evidence/rag-copilot/">Evidence memo</a>
      </div>

      <div style="height:14px"></div>

      <div class="actions">
        <a class="btn" href="/evidence/#rag-copilot">Proof anchor</a>
        <a class="btn" href="/evidence/rag-copilot/">Open memo</a>
        <a class="btn primary" href="/demos/">Systems index</a>
      </div>
    </section>

    <section class="section">
      <div class="stack">

        <!-- Main interaction -->
        <article class="card">
          <h2>Ask a question</h2>
          <p class="lead">
            This demo does not “hallucinate”: it drafts only from retrieved sources. If evidence is weak, it refuses (Strict policy).
          </p>

          <div class="field">
            <label class="tiny" for="q">Query</label>
            <input id="q" class="input" type="text" placeholder="e.g. What should be monitored for deployed ML models? Provide citations." />
          </div>

          <div class="row" style="margin-top:10px;">
            <button id="run" class="btn primary" type="button">Run retrieval + draft</button>
            <button id="clear" class="btn" type="button">Clear</button>
            <button id="copyTrace" class="btn" type="button">Export trace JSON</button>
            <button id="copyCites" class="btn" type="button">Copy citations</button>
          </div>

          <div class="hr"></div>

          <div class="field">
            <label class="tiny">Answer (grounded draft)</label>
            <div id="answer" class="panel">
              <p class="muted" style="margin:0;">
                Run a query to see a grounded draft with citations. Use <span class="kbd">Strict</span> to enforce refusals on weak evidence.
              </p>
            </div>
          </div>

          <div style="height:10px"></div>

          <details class="trace" id="traceBox">
            <summary>Retrieval trace (top-k sources, similarity, snippets)</summary>
            <div id="trace" class="traceList"></div>
          </details>

          <p class="tiny" style="margin-top:10px;">
            Screening signal: a reviewer can verify faithfulness by comparing the answer to the retrieved snippets.
          </p>
        </article>

        <!-- Right panel -->
        <aside class="card">
          <h2>Policy & examples</h2>
          <p class="tiny">
            Choose how strict the system should be when evidence is weak. This models real LLMOps trade-offs.
          </p>

          <div class="policy" role="radiogroup" aria-label="Policy mode">
            <label>
              <input type="radio" name="policy" value="strict" checked />
              <div>
                <strong>Strict (recommended)</strong><br />
                <span class="tiny">Refuses if top similarity is below threshold. Optimised for reliability and auditability.</span>
              </div>
            </label>

            <label>
              <input type="radio" name="policy" value="lenient" />
              <div>
                <strong>Lenient</strong><br />
                <span class="tiny">Drafts a cautious answer even with weaker retrieval, but still cites sources and flags uncertainty.</span>
              </div>
            </label>
          </div>

          <div class="hr"></div>

          <h3>Example queries</h3>
          <div class="tags" aria-label="Example queries">
            <button class="tag" data-example="What should be monitored for deployed ML models? Provide citations.">Model monitoring</button>
            <button class="tag" data-example="Explain CI/CD for ML deployment and why model artefact versioning matters. Cite sources.">CI/CD for ML</button>
            <button class="tag" data-example="What is data drift vs prediction drift, and how do you detect them? Provide citations.">Drift detection</button>
            <button class="tag" data-example="Describe a safe RAG workflow with guardrails against prompt injection. Cite sources.">RAG guardrails</button>
            <button class="tag" data-example="What is a feature store and when would you use one? Provide citations.">Feature store</button>
          </div>

          <p class="tiny" style="margin-top:10px;">
            ATS keywords surfaced here: <span class="kbd">RAG</span>, <span class="kbd">LLMOps</span>, <span class="kbd">CI/CD for ML</span>,
            <span class="kbd">Model Serving</span>, <span class="kbd">Monitoring</span>, <span class="kbd">Drift</span>.
          </p>

          <div class="hr"></div>

          <h3>Local corpus</h3>
          <p class="tiny">
            Retrieval runs over a small curated corpus embedded in this page. In production, the same interface maps to a vector store.
          </p>

          <div class="actions">
            <a class="btn" href="/evidence/rag-copilot/">Read the evidence memo</a>
            <a class="btn" href="/evidence/#rag-copilot">Go to proof anchor</a>
          </div>
        </aside>
      </div>
    </section>

    <footer class="footer">
      <div>© <span id="year"></span> Neuromorphic Inference Lab</div>
      <div class="prov">
        <span id="build-branch">branch: …</span>
        <span id="build-commit">commit: …</span>
        <span id="build-time">built: …</span>
      </div>
    </footer>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    document.getElementById("year").textContent = String(new Date().getFullYear());
  </script>
  <script src="/build-info.js"></script>

  <script>
    // -----------------------------
    // RAG Copilot (client-only)
    // -----------------------------

    const CORPUS = [
      {
        id: "doc-ml-monitoring",
        title: "Model Monitoring: What to Track in Production",
        source: "Neuromorphic Inference Lab (internal memo)",
        url: "/evidence/#rag-copilot",
        text: `
Monitoring deployed ML requires both engineering and modelling signals. Track service health (latency, throughput, error rates),
model performance proxies (prediction distribution shift), and delayed ground-truth performance where available.
Key concepts include data drift vs prediction drift, feature schema validation, and alerting tied to business impact.
Operationally, define retraining triggers, rollback criteria, and monitoring dashboards for reliability.
        `.trim()
      },
      {
        id: "doc-cicd-ml",
        title: "CI/CD for ML: Artefacts, Reproducibility, and Safe Releases",
        source: "Neuromorphic Inference Lab (internal memo)",
        url: "/evidence/#mv-grid-fault-risk",
        text: `
CI/CD for ML extends software delivery with model-specific gates: data validation, evaluation checks, and artefact versioning.
A safe release pipeline stores trained models as versioned artefacts, captures lineage metadata, and supports rollbacks.
Automated tests include schema checks, unit tests for transforms, and regression checks on evaluation metrics.
        `.trim()
      },
      {
        id: "doc-drift",
        title: "Drift: Data Drift vs Prediction Drift",
        source: "Neuromorphic Inference Lab (internal memo)",
        url: "/evidence/#forecast-studio",
        text: `
Data drift describes changes in input feature distributions. Prediction drift describes changes in model outputs over time.
Both can be monitored using statistical tests, distance metrics, and distribution summaries.
Drift alerts should be paired with remediation: investigate pipeline changes, update feature engineering, retrain or recalibrate.
        `.trim()
      },
      {
        id: "doc-feature-store",
        title: "Feature Stores: When and Why",
        source: "Neuromorphic Inference Lab (internal memo)",
        url: "/evidence/#mv-grid-fault-risk",
        text: `
A feature store is used when consistent feature computation is needed across training and serving, especially at scale.
It improves reproducibility, reduces training-serving skew, and enables feature reuse across teams and models.
Feature stores also support governance: lineage, access control, and monitoring of feature freshness.
        `.trim()
      },
      {
        id: "doc-rag-guardrails",
        title: "RAG Guardrails: Grounding, Refusal, and Prompt Injection Defence",
        source: "Neuromorphic Inference Lab (internal memo)",
        url: "/evidence/#rag-copilot",
        text: `
Reliable RAG requires explicit grounding: answers should be constrained to retrieved evidence.
If retrieval confidence is weak, the system should refuse or ask clarifying questions.
Prompt injection defence includes treating retrieved text as untrusted data, applying allow-list behaviour, and auditing traces.
Evaluation harnesses measure precision@k, citation correctness, and refusal correctness.
        `.trim()
      },
      {
        id: "doc-evaluation",
        title: "Evaluation Mindset: Beyond a Single Score",
        source: "Neuromorphic Inference Lab (internal memo)",
        url: "/evidence/#forecast-studio",
        text: `
Production evaluation is continuous. Use backtesting for forecasting, and structured evaluation datasets for LLM workflows.
Track performance across slices, horizons, and time windows. Use regression tests to prevent silent metric degradation.
Always connect metrics to operational consequences: latency budgets, cost constraints, and business impact.
        `.trim()
      }
    ];

    // Simple tokeniser
    function tokens(s){
      return (s || "")
        .toLowerCase()
        .replace(/[^a-z0-9\s\-]/g, " ")
        .split(/\s+/)
        .filter(t => t && t.length > 2);
    }

    // Build TF-IDF-ish weights (lightweight, deterministic)
    const DOCS = CORPUS.map(d => {
      const t = tokens(d.text + " " + d.title);
      const tf = new Map();
      for (const w of t) tf.set(w, (tf.get(w) || 0) + 1);
      return { ...d, tf, len: t.length };
    });

    const DF = new Map();
    for (const d of DOCS){
      for (const w of new Set(d.tf.keys())){
        DF.set(w, (DF.get(w) || 0) + 1);
      }
    }

    function idf(w){
      const df = DF.get(w) || 0;
      const N = DOCS.length;
      return Math.log((N + 1) / (df + 1)) + 1.0;
    }

    // Vector normalisation helpers
    function dot(a, b){
      let s = 0;
      for (const [k, v] of a){
        const bv = b.get(k);
        if (bv) s += v * bv;
      }
      return s;
    }
    function norm(a){
      let s = 0;
      for (const [, v] of a) s += v * v;
      return Math.sqrt(s) || 1;
    }

    function toTfidfVectorFromTokens(toks){
      const tf = new Map();
      for (const w of toks) tf.set(w, (tf.get(w) || 0) + 1);
      const v = new Map();
      for (const [w, c] of tf){
        v.set(w, (c / toks.length) * idf(w));
      }
      return v;
    }

    // Precompute doc vectors
    for (const d of DOCS){
      const toks = tokens(d.text + " " + d.title);
      d.vec = toTfidfVectorFromTokens(toks);
      d.n = norm(d.vec);
    }

    function retrieve(query, k=3){
      const qtoks = tokens(query);
      const qvec = toTfidfVectorFromTokens(qtoks);
      const qn = norm(qvec);

      const scored = DOCS.map(d => {
        const sim = dot(qvec, d.vec) / (qn * d.n);
        return { doc: d, sim };
      }).sort((a,b)=> b.sim - a.sim);

      const top = scored.slice(0, k);
      const maxSim = top.length ? top[0].sim : 0;
      return { top, maxSim };
    }

    function pickSnippets(text, query){
      // pick up to 2 “sentences” that share tokens with the query
      const qset = new Set(tokens(query));
      const sentences = text
        .replace(/\s+/g, " ")
        .split(/(?<=[\.\!\?])\s+/)
        .map(s => s.trim())
        .filter(Boolean);

      const ranked = sentences.map(s => {
        const ts = tokens(s);
        let hit = 0;
        for (const w of ts) if (qset.has(w)) hit += 1;
        return { s, hit };
      }).sort((a,b)=> b.hit - a.hit);

      const chosen = ranked.filter(r => r.hit > 0).slice(0, 2).map(r => r.s);
      if (chosen.length) return chosen;

      // fallback: first ~180 chars
      return [text.slice(0, 180) + (text.length > 180 ? "…" : "")];
    }

    function buildAnswer(query, hits, policy){
      // This is a *drafting* demo, not an LLM. We produce a structured answer with citations.
      const top = hits.map((h, i) => {
        const snippets = pickSnippets(h.doc.text, query);
        return { i: i+1, title: h.doc.title, url: h.doc.url, snippets };
      });

      if (!top.length){
        return { html: `<p class="muted" style="margin:0;">No sources available.</p>`, cites: "" };
      }

      const cautious = policy === "lenient";

      const bullets = [];
      // Pull key lines from top sources
      for (const t of top){
        const s1 = t.snippets[0] || "";
        bullets.push(`<li>${escapeHtml(s1)} <span class="mono">[${t.i}]</span></li>`);
      }

      const preface = cautious
        ? `<p style="margin:0 0 10px;"><strong>Draft (cautious):</strong> evidence is limited; conclusions are bounded by retrieved sources.</p>`
        : `<p style="margin:0 0 10px;"><strong>Grounded draft:</strong> constructed strictly from retrieved sources.</p>`;

      const html = `
        ${preface}
        <ul class="clean">${bullets.join("")}</ul>
        <p class="tiny" style="margin-top:10px;">
          Citations: ${top.map(t => `<span class="mono">[${t.i}]</span> ${escapeHtml(t.title)}`).join(" · ")}
        </p>
      `.trim();

      const citeText = top.map(t => `[${t.i}] ${t.title} — ${t.url}`).join("\n");
      return { html, cites: citeText };
    }

    function escapeHtml(s){
      return (s || "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    function toast(msg){
      const el = document.getElementById("toast");
      el.textContent = msg;
      el.classList.add("show");
      setTimeout(()=> el.classList.remove("show"), 1400);
    }

    function currentPolicy(){
      const v = document.querySelector('input[name="policy"]:checked')?.value || "strict";
      return v;
    }

    function strictThreshold(){
      // tuned for small corpus; in real systems this could be dynamic
      return 0.13;
    }

    function renderTrace(hits){
      const trace = document.getElementById("trace");
      trace.innerHTML = "";

      if (!hits.length){
        trace.innerHTML = `<div class="panel"><p class="muted" style="margin:0;">No retrieved sources.</p></div>`;
        return;
      }

      const max = Math.max(...hits.map(h => h.sim), 1e-9);

      for (let idx=0; idx<hits.length; idx++){
        const h = hits[idx];
        const rank = idx + 1;
        const pct = Math.max(0, Math.min(100, (h.sim / max) * 100));
        const snippets = pickSnippets(h.doc.text, document.getElementById("q").value);

        const hit = document.createElement("div");
        hit.className = "hit";
        hit.innerHTML = `
          <div class="hitTop">
            <div>
              <strong class="mono">[${rank}]</strong> ${escapeHtml(h.doc.title)}
              <div class="tiny">${escapeHtml(h.doc.source)} · <a href="${h.doc.url}" class="mono">open</a></div>
            </div>
            <div class="row">
              <div class="tiny mono">sim ${h.sim.toFixed(3)}</div>
              <div class="scoreBar" aria-label="Similarity score">
                <div class="scoreFill" style="width:${pct.toFixed(0)}%"></div>
              </div>
            </div>
          </div>
          <div class="tiny" style="margin-top:8px;">
            ${snippets.map(s => `<div>• ${escapeHtml(s)}</div>`).join("")}
          </div>
        `;
        trace.appendChild(hit);
      }
    }

    let lastTrace = null;
    let lastCitations = "";

    function run(){
      const q = document.getElementById("q").value.trim();
      const policy = currentPolicy();

      if (!q){
        toast("Please enter a query.");
        return;
      }

      const { top, maxSim } = retrieve(q, 3);
      const threshold = strictThreshold();

      // Strict refusal on weak retrieval
      if (policy === "strict" && maxSim < threshold){
        document.getElementById("answer").innerHTML = `
          <p style="margin:0 0 8px;"><strong>Refusal (Strict policy):</strong> evidence is too weak to answer safely.</p>
          <p class="tiny" style="margin:0;">
            Try rephrasing, add more context, or use <span class="kbd">Lenient</span> to get a cautious draft.
            <span class="mono">top similarity=${maxSim.toFixed(3)}</span>, threshold=${threshold.toFixed(3)}.
          </p>
        `;
        renderTrace(top);
        document.getElementById("traceBox").open = true;

        lastTrace = buildTraceJson(q, policy, top, maxSim, threshold, true);
        lastCitations = buildCitations(top);
        return;
      }

      // Build grounded draft
      const answer = buildAnswer(q, top, policy);
      document.getElementById("answer").innerHTML = answer.html;
      renderTrace(top);
      document.getElementById("traceBox").open = true;

      lastTrace = buildTraceJson(q, policy, top, maxSim, threshold, false);
      lastCitations = answer.cites;

      toast("Draft generated with retrieval trace.");
    }

    function buildCitations(top){
      return top.map((h, i) => `[${i+1}] ${h.doc.title} — ${h.doc.url}`).join("\n");
    }

    function buildTraceJson(q, policy, top, maxSim, threshold, refused){
      const now = new Date().toISOString();
      return {
        schema_version: "nil.rag.trace.v1",
        generated_at: now,
        policy,
        refused,
        thresholds: { strict_similarity_threshold: threshold },
        query: q,
        retrieval: {
          top_k: top.map((h, i) => ({
            rank: i+1,
            doc_id: h.doc.id,
            title: h.doc.title,
            source: h.doc.source,
            url: h.doc.url,
            similarity: Number(h.sim.toFixed(6)),
            snippets: pickSnippets(h.doc.text, q)
          })),
          top_similarity: Number(maxSim.toFixed(6))
        }
      };
    }

    async function copyTrace(){
      if (!lastTrace){
        toast("Run a query first.");
        return;
      }
      const json = JSON.stringify(lastTrace, null, 2);
      try {
        await navigator.clipboard.writeText(json);
        toast("Trace JSON copied to clipboard.");
      } catch {
        toast("Clipboard blocked by browser.");
      }
    }

    async function copyCitations(){
      if (!lastCitations){
        toast("Run a query first.");
        return;
      }
      try {
        await navigator.clipboard.writeText(lastCitations);
        toast("Citations copied.");
      } catch {
        toast("Clipboard blocked by browser.");
      }
    }

    function clearAll(){
      document.getElementById("q").value = "";
      document.getElementById("answer").innerHTML = `<p class="muted" style="margin:0;">Cleared. Run a query to generate a grounded draft.</p>`;
      document.getElementById("trace").innerHTML = "";
      document.getElementById("traceBox").open = false;
      lastTrace = null;
      lastCitations = "";
      toast("Cleared.");
    }

    // Wire up UI
    document.getElementById("run").addEventListener("click", run);
    document.getElementById("clear").addEventListener("click", clearAll);
    document.getElementById("copyTrace").addEventListener("click", copyTrace);
    document.getElementById("copyCites").addEventListener("click", copyCitations);

    document.getElementById("q").addEventListener("keydown", (e) => {
      if (e.key === "Enter"){
        e.preventDefault();
        run();
      }
    });

    // Example query buttons
    for (const btn of document.querySelectorAll("[data-example]")){
      btn.addEventListener("click", () => {
        document.getElementById("q").value = btn.getAttribute("data-example") || "";
        toast("Example query loaded.");
      });
    }
  </script>
</body>
</html>
