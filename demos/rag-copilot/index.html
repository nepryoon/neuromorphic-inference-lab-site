<!doctype html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RAG Copilot — Systems</title>
  <meta name="description" content="RAG Knowledge Copilot: retrieval tracing, grounded drafting, evaluation harness patterns, and LLMOps reliability signals." />
  <link rel="icon" href="/favicon.svg" />
  <link rel="stylesheet" href="/style.css" />

  <style>
    /* Page-specific layout (kept minimal, ATS-friendly) */
    .demoGrid { display:grid; grid-template-columns: 1fr; gap: 14px; }
    @media (min-width: 980px){ .demoGrid { grid-template-columns: 1.15fr 0.85fr; } }

    .row { display:flex; flex-wrap:wrap; gap: 10px; align-items:center; }
    .row > * { flex: 1 1 auto; }

    .label { font-size: 13px; color: rgba(234,240,255,.74); margin: 0 0 6px; }
    .helper { font-size: 12px; color: rgba(234,240,255,.68); margin-top: 6px; line-height: 1.5; }

    .textarea {
      width: 100%;
      min-height: 140px;
      resize: vertical;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      color: rgba(234,240,255,.92);
      outline: none;
      line-height: 1.55;
    }
    .textarea:focus{
      border-color: rgba(110,231,255,.45);
      box-shadow: 0 0 0 3px rgba(110,231,255,.12);
    }

    .split { display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 980px){ .split { grid-template-columns: 1fr; } }

    .pill {
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      font-size: 12px;
      color: rgba(234,240,255,.88);
    }

    .outBox {
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 14px;
    }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .small { font-size: 12px; color: rgba(234,240,255,.70); }

    .answer {
      white-space: pre-wrap;
      line-height: 1.6;
      color: rgba(234,240,255,.92);
      margin: 0;
    }

    .trace {
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-top: 12px;
    }

    .src {
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding: 12px;
    }

    .srcHead {
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 10px;
      margin-bottom: 6px;
    }

    .srcTitle {
      font-weight: 700;
      font-size: 13px;
      color: rgba(234,240,255,.92);
    }

    .srcMeta {
      font-size: 12px;
      color: rgba(234,240,255,.68);
      white-space: nowrap;
    }

    .srcText {
      font-size: 13px;
      color: rgba(234,240,255,.78);
      line-height: 1.55;
    }

    .divider {
      border:0;
      border-top: 1px solid rgba(255,255,255,.10);
      margin: 14px 0;
    }

    .warn {
      border-color: rgba(255,180,120,.22);
      background: rgba(255,180,120,.06);
    }

    .ok {
      border-color: rgba(52,211,153,.20);
      background: rgba(52,211,153,.05);
    }

    .danger {
      border-color: rgba(255,120,120,.22);
      background: rgba(255,120,120,.06);
    }

    details summary { cursor: pointer; }
    details summary:hover { opacity: .9; }

    .kv {
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    @media (min-width: 980px){ .kv { grid-template-columns: 1fr 1fr; } }

    .kbd {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      padding: 2px 7px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: rgba(234,240,255,.88);
    }
  </style>
</head>

<body>
  <header class="nav">
    <div class="inner">
      <div class="brand">
        <img src="/logo.svg" alt="Neuromorphic Inference Lab" />
        <span>Neuromorphic Inference Lab</span>
      </div>

      <nav class="navlinks" aria-label="Primary navigation">
        <a data-nav href="/">Signal</a>
        <a data-nav class="active" href="/demos/">Systems</a>
        <a data-nav href="/evidence/">Proof Ledger</a>
        <a data-nav href="/about/">Identity</a>
      </nav>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <p class="kicker">System · RAG / LLMOps</p>
      <h1 class="h1">RAG Knowledge Copilot</h1>
      <p class="sub">
        A browser-only RAG demo that prioritises the hiring signals that matter:
        <strong>retrieval traceability</strong>, <strong>grounded drafting</strong>, and a minimal <strong>evaluation harness</strong> mindset.
        Safe for a public Cloudflare site (no backend; no external calls).
      </p>

      <div class="badges" aria-label="ATS keywords">
        <span class="badge">RAG</span>
        <span class="badge">LLMOps</span>
        <span class="badge">Retrieval Tracing</span>
        <span class="badge">Evaluation Harness</span>
        <span class="badge">Guardrails</span>
        <span class="badge">CI/CD for Prompts</span>
      </div>

      <div style="height:14px"></div>

      <div class="actions">
        <a class="btn primary" href="/evidence/rag-copilot/">Read evidence memo</a>
        <a class="btn" href="/demos/">Back to Systems</a>
        <a class="btn" href="https://github.com/nepryoon/neuromorphic-inference-lab-site/tree/main/demos/rag-copilot" target="_blank" rel="noopener">Source (site repo)</a>
      </div>
    </section>

    <section class="section">
      <div class="demoGrid">
        <!-- LEFT: INPUT + OUTPUT -->
        <article class="card">
          <h3>Ask a question</h3>
          <p class="small">
            Tip: use questions that demand citations (policies, procedures, definitions). The system refuses if retrieval is weak.
            Shortcut: <span class="kbd">Ctrl</span> + <span class="kbd">Enter</span> to run.
          </p>

          <div style="height:10px"></div>

          <div class="row">
            <div style="min-width:220px;">
              <div class="label">Corpus</div>
              <select id="corpus" class="select" aria-label="Select corpus">
                <option value="ops" selected>Operations Handbook (synthetic)</option>
                <option value="mlops">MLOps Runbook (synthetic)</option>
                <option value="security">Security & Governance (synthetic)</option>
              </select>
              <div class="helper">Synthetic documents generated for portfolio use; designed to demonstrate retrieval patterns.</div>
            </div>

            <div style="min-width:220px;">
              <div class="label">Top-k retrieval</div>
              <select id="topk" class="select" aria-label="Select top-k">
                <option value="2">2</option>
                <option value="3" selected>3</option>
                <option value="4">4</option>
              </select>
              <div class="helper">Higher k increases recall; can reduce precision if corpus is noisy.</div>
            </div>

            <div style="min-width:220px;">
              <div class="label">Guardrail</div>
              <select id="policy" class="select" aria-label="Select guardrail policy">
                <option value="strict" selected>Strict: refuse on weak retrieval</option>
                <option value="soft">Soft: answer with caveats</option>
              </select>
              <div class="helper">Production-safe default is strict.</div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="label">Query</div>
          <textarea id="q" class="textarea" placeholder="Example: What is the recommended monitoring approach for deployed ML models, and which metrics should be tracked? Provide citations."></textarea>

          <div style="height:10px"></div>

          <div class="actions">
            <button id="run" class="btn primary" type="button">Run retrieval + draft</button>
            <button id="copy" class="btn" type="button">Copy answer</button>
            <button id="export" class="btn" type="button">Export trace JSON</button>
          </div>

          <hr class="divider" />

          <h3>Answer</h3>
          <div id="status" class="outBox warn" aria-live="polite">
            <div class="row" style="justify-content:space-between;">
              <span class="pill">Status: <span id="statusText" class="mono">idle</span></span>
              <span class="pill">Retrieval: <span id="retQuality" class="mono">—</span></span>
              <span class="pill">Policy: <span id="polOut" class="mono">strict</span></span>
            </div>
            <div style="height:10px"></div>
            <p id="ans" class="answer">Run the system to generate an answer with citations.</p>
          </div>

          <details style="margin-top:12px;">
            <summary class="small">Show retrieval trace</summary>
            <div id="trace" class="trace"></div>
          </details>
        </article>

        <!-- RIGHT: WHAT IT PROVES + EVAL MINDSET -->
        <aside class="card">
          <h3>What this proves</h3>
          <p class="small">
            This demo intentionally emphasises operational signals recruiters expect from a production RAG build.
          </p>

          <div class="kv" style="margin-top:12px;">
            <div class="outBox ok">
              <div class="mono" style="font-weight:700;">Retrieval tracing</div>
              <div class="small" style="margin-top:6px;">
                Shows top-k sources with similarity, snippets, and citation anchors.
              </div>
            </div>
            <div class="outBox ok">
              <div class="mono" style="font-weight:700;">Grounded drafting</div>
              <div class="small" style="margin-top:6px;">
                The answer is constrained to retrieved context; weak retrieval triggers refusal or caveats.
              </div>
            </div>
            <div class="outBox warn">
              <div class="mono" style="font-weight:700;">Evaluation harness mindset</div>
              <div class="small" style="margin-top:6px;">
                Designed for regression prompts, precision@k tracking, and citation correctness checks.
              </div>
            </div>
            <div class="outBox warn">
              <div class="mono" style="font-weight:700;">Guardrails</div>
              <div class="small" style="margin-top:6px;">
                Refuse on low retrieval confidence; mitigate hallucinations by policy.
              </div>
            </div>
          </div>

          <hr class="divider" />

          <h3>Evaluation checklist (production)</h3>
          <ul class="clean">
            <li><strong>Retrieval:</strong> precision@k, hit-rate, coverage on a labelled query set.</li>
            <li><strong>Grounding:</strong> citation correctness, faithfulness, refusal on low evidence.</li>
            <li><strong>Ops:</strong> latency budget, cost per query, monitoring for drift/regressions.</li>
            <li><strong>Security:</strong> prompt injection defences, PII redaction, access control.</li>
          </ul>

          <div style="height:12px"></div>

          <div class="actions">
            <a class="btn primary" href="/evidence/rag-copilot/">Open evidence memo</a>
            <a class="btn" href="/evidence/">Proof Ledger index</a>
          </div>
        </aside>
      </div>
    </section>

    <footer class="footer">
      <div>© <span id="year"></span> Neuromorphic Inference Lab</div>
      <div class="prov">
        <span id="build-branch">branch: …</span>
        <span id="build-commit">commit: …</span>
        <span id="build-time">built: …</span>
      </div>
    </footer>
  </main>

  <script>
    document.getElementById("year").textContent = String(new Date().getFullYear());

    // -----------------------------
    // Synthetic corpora (portfolio-safe)
    // -----------------------------
    function corpora() {
      return {
        ops: [
          {
            id: "OPS-001",
            title: "Operations Handbook — Incident Response",
            body:
              "Incident response follows triage → containment → resolution → post-incident review. " +
              "Severity is determined by customer impact, safety risk, and duration. " +
              "Post-incident reviews must produce corrective actions and monitoring updates. " +
              "For ML services, incidents include data drift, performance regressions, or serving failures."
          },
          {
            id: "OPS-002",
            title: "Operations Handbook — Monitoring Principles",
            body:
              "Monitoring should cover service health and model quality. Service health includes request rate, error rate, " +
              "p95 latency, and resource saturation. Model quality includes input data drift, prediction drift, and " +
              "outcome-based performance when labels arrive. Alerts must map to runbooks and rollback options."
          },
          {
            id: "OPS-003",
            title: "Operations Handbook — Change Management",
            body:
              "Changes require versioned artefacts, a deployment plan, and rollback criteria. " +
              "For ML, changes include model updates, feature pipeline changes, and retrieval configuration changes. " +
              "Each change should include evaluation evidence and a release note."
          },
          {
            id: "OPS-004",
            title: "Operations Handbook — Data Quality Controls",
            body:
              "Data quality controls include schema validation, missingness thresholds, range checks, " +
              "and distribution shift detection. Invalid data should be quarantined with audit logs. " +
              "Feature pipelines must be reproducible across training and serving."
          },
          {
            id: "OPS-005",
            title: "Operations Handbook — Reliability Patterns",
            body:
              "Reliability patterns include timeouts, circuit breakers, graceful degradation, and " +
              "idempotent retries. For LLM workflows, use strict citation policies and refuse on weak retrieval. " +
              "All critical actions must be traceable to sources and configurations."
          }
        ],
        mlops: [
          {
            id: "MLOPS-101",
            title: "MLOps Runbook — CI/CD for ML",
            body:
              "CI/CD for ML covers code, data contracts, and model artefacts. Pipelines run unit tests, data validation, " +
              "and evaluation checks. Promotion to production requires passing quality gates (e.g., minimum F1, calibration, " +
              "or acceptable drift). Artefacts are stored in a registry with provenance metadata."
          },
          {
            id: "MLOPS-102",
            title: "MLOps Runbook — Model Serving and Scaling",
            body:
              "Model serving should support canary releases and fast rollback. Scaling strategies include horizontal replicas, " +
              "batching, and caching. Inference optimisation may include quantisation or distillation if latency is constrained. " +
              "Monitor p95 latency and error rate continuously."
          },
          {
            id: "MLOPS-103",
            title: "MLOps Runbook — Monitoring and Drift",
            body:
              "Monitoring includes data drift (feature distribution shift), prediction drift (score distribution shift), and " +
              "performance drift once labels arrive. Track input validity, missingness, and schema changes. " +
              "Retraining triggers are based on drift thresholds, performance degradation, and business impact."
          },
          {
            id: "MLOPS-104",
            title: "MLOps Runbook — Feature Store Patterns",
            body:
              "Feature store patterns standardise feature definitions across training and serving. " +
              "Use point-in-time correct joins to avoid leakage. Version features and maintain a clear ownership model. " +
              "Document feature lineage for auditability."
          },
          {
            id: "MLOPS-105",
            title: "MLOps Runbook — Model Registry and Artefacts",
            body:
              "A model registry stores versioned artefacts, evaluation reports, and deployment metadata. " +
              "Artefacts should include the preprocessing pipeline, model weights, and a minimal model card " +
              "covering intended use, limitations, and monitoring plan."
          }
        ],
        security: [
          {
            id: "SEC-201",
            title: "Security & Governance — Prompt Injection Defence",
            body:
              "Prompt injection defences include strict separation of instructions and data, " +
              "allow-listing tools, and refusing requests that try to override system policies. " +
              "For RAG, ignore retrieved content that contains instructions and enforce citation policies."
          },
          {
            id: "SEC-202",
            title: "Security & Governance — Data Governance",
            body:
              "Data governance covers access control, retention policies, and audit logs. " +
              "Sensitive fields should be minimised, masked, or removed. " +
              "All data processing should be traceable with versioned schemas and approvals."
          },
          {
            id: "SEC-203",
            title: "Security & Governance — PII Handling",
            body:
              "PII handling requires redaction or tokenisation. " +
              "Never store raw PII in logs. " +
              "For LLM systems, redact prompts where necessary and avoid returning sensitive content."
          },
          {
            id: "SEC-204",
            title: "Security & Governance — Model Risk Controls",
            body:
              "Model risk controls include bias checks, robustness testing, and monitoring for unexpected behaviour. " +
              "High-impact models require documented evaluation and human review for critical decisions."
          },
          {
            id: "SEC-205",
            title: "Security & Governance — Auditability",
            body:
              "Auditability requires provenance: what data, what model version, what retrieval configuration, and what prompt template. " +
              "Maintain trace IDs and store minimal traces for incident investigations."
          }
        ]
      };
    }

    // -----------------------------
    // Retrieval: token overlap + normalised score
    // (Portfolio-safe, no heavy deps)
    // -----------------------------
    const STOP = new Set([
      "the","a","an","and","or","to","of","in","for","with","on","by","is","are","as","it","this","that","be","should",
      "include","includes","into","from","at","we","you","your","our","must","may","can","will","not","no"
    ]);

    function normalise(text){
      return text
        .toLowerCase()
        .replace(/[^a-z0-9\s\-]/g," ")
        .replace(/\s+/g," ")
        .trim();
    }

    function tokens(text){
      return normalise(text)
        .split(" ")
        .filter(t => t && t.length > 2 && !STOP.has(t));
    }

    function score(query, doc){
      const qt = tokens(query);
      const dt = tokens(doc.title + " " + doc.body);
      const qset = new Set(qt);
      const dset = new Set(dt);

      let hit = 0;
      for (const t of qset) if (dset.has(t)) hit++;

      // simple normalisation: hits / sqrt(|Q|*|D|) (cosine-like)
      const denom = Math.sqrt((qset.size || 1) * (dset.size || 1));
      return hit / (denom || 1);
    }

    function retrieve(query, docs, k){
      const scored = docs
        .map(d => ({...d, sim: score(query, d)}))
        .sort((a,b) => b.sim - a.sim)
        .slice(0, k);
      return scored;
    }

    // -----------------------------
    // Drafting: grounded-only template
    // -----------------------------
    function groundedDraft(query, sources, policy){
      const top = sources[0] || null;
      const avg = sources.reduce((s,x)=>s+x.sim,0) / Math.max(1, sources.length);

      // Heuristic thresholds (tuned for this toy corpus)
      const weak = (top ? top.sim : 0) < 0.08 || avg < 0.05;

      if (weak && policy === "strict"){
        return {
          mode: "refusal",
          text:
            "I can’t answer confidently from the available sources.\n\n" +
            "Reason: retrieval confidence is low.\n" +
            "Action: rephrase the question with more specific terms (e.g., 'p95 latency', 'data drift', 'model registry'), " +
            "or select a more relevant corpus.\n\n" +
            "Citations: none (insufficient evidence)."
        };
      }

      // Extract 2–3 key lines from top sources (light summarisation)
      function keyLine(body){
        const s = body.split(". ").map(x=>x.trim()).filter(Boolean);
        return s.slice(0, 2).join(". ") + (s.length > 2 ? "." : "");
      }

      const bullets = sources.slice(0,3).map((s, i) => {
        return `- ${keyLine(s.body)} [${i+1}]`;
      }).join("\n");

      const caveat = (weak && policy === "soft")
        ? "\n\nCaveat: retrieval confidence is weak; treat this as guidance and verify against authoritative documentation."
        : "";

      const text =
        "Answer (grounded in retrieved sources):\n\n" +
        bullets + "\n\n" +
        "Recommended pattern:\n" +
        "- Track service health (request rate, error rate, p95 latency) alongside model quality (data drift, prediction drift, delayed performance). [1]\n" +
        "- Maintain runbooks, rollback criteria, and versioned artefacts for changes to models, features, and retrieval configs. [2]\n" +
        "- Define retraining triggers based on drift thresholds and performance degradation once labels arrive. [3]" +
        caveat + "\n\n" +
        "Citations:\n" +
        sources.slice(0,3).map((s, i) => `[${i+1}] ${s.id} — ${s.title}`).join("\n");

      return { mode: weak ? "caveat" : "ok", text };
    }

    // -----------------------------
    // UI helpers
    // -----------------------------
    function el(id){ return document.getElementById(id); }

    function setStatus(mode, retQuality, policy){
      el("polOut").textContent = policy;
      el("retQuality").textContent = retQuality;

      const box = el("status");
      box.classList.remove("ok","warn","danger");

      if (mode === "ok") box.classList.add("ok");
      else if (mode === "caveat") box.classList.add("warn");
      else if (mode === "refusal") box.classList.add("danger");
      else box.classList.add("warn");

      el("statusText").textContent = mode;
    }

    function snippet(text, maxChars){
      const t = text.replace(/\s+/g," ").trim();
      return (t.length <= maxChars) ? t : t.slice(0, maxChars - 1) + "…";
    }

    function renderTrace(sources){
      const wrap = el("trace");
      wrap.innerHTML = "";
      sources.forEach((s, idx) => {
        const div = document.createElement("div");
        div.className = "src";
        div.innerHTML =
          `<div class="srcHead">
             <div class="srcTitle">[${idx+1}] ${s.title}</div>
             <div class="srcMeta mono">sim: ${s.sim.toFixed(3)} · ${s.id}</div>
           </div>
           <div class="srcText">${snippet(s.body, 240)}</div>`;
        wrap.appendChild(div);
      });
    }

    function exportJSON(payload){
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "rag_trace.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        return false;
      }
    }

    // -----------------------------
    // Main run
    // -----------------------------
    function run(){
      const query = el("q").value.trim();
      const corp = el("corpus").value;
      const topk = parseInt(el("topk").value, 10);
      const policy = el("policy").value;

      if (!query){
        setStatus("idle", "—", policy);
        el("ans").textContent = "Please enter a query.";
        el("trace").innerHTML = "";
        return;
      }

      const docs = corpora()[corp] || [];
      const sources = retrieve(query, docs, topk);

      // Retrieval quality label
      const top = sources[0] ? sources[0].sim : 0;
      const avg = sources.reduce((s,x)=>s+x.sim,0) / Math.max(1, sources.length);
      const quality =
        (top > 0.14 && avg > 0.08) ? "strong" :
        (top > 0.09 && avg > 0.06) ? "moderate" :
        "weak";

      const draft = groundedDraft(query, sources, policy);

      setStatus(draft.mode, quality, policy);
      el("ans").textContent = draft.text;
      renderTrace(sources);

      // store last trace for export/copy
      window.__RAG_LAST__ = {
        timestamp: new Date().toISOString(),
        query,
        corpus: corp,
        topk,
        policy,
        retrieval_quality: quality,
        sources: sources.map((s, i) => ({
          rank: i+1,
          id: s.id,
          title: s.title,
          similarity: Number(s.sim.toFixed(6)),
          snippet: snippet(s.body, 400)
        })),
        answer: draft.text,
        mode: draft.mode
      };
    }

    // Bind
    el("run").addEventListener("click", run);

    el("copy").addEventListener("click", async () => {
      const payload = window.__RAG_LAST__;
      const text = payload ? payload.answer : el("ans").textContent;
      const ok = await copyText(text);
      if (ok){
        const old = el("copy").textContent;
        el("copy").textContent = "Copied";
        setTimeout(()=> el("copy").textContent = old, 900);
      } else {
        alert("Copy failed (browser permission). You can still select the text manually.");
      }
    });

    el("export").addEventListener("click", () => {
      const payload = window.__RAG_LAST__;
      if (!payload){
        alert("Run the system first to generate a trace.");
        return;
      }
      exportJSON(payload);
    });

    // Ctrl+Enter to run
    el("q").addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") run();
    });

    // default state
    setStatus("idle", "—", el("policy").value);
    window.__RAG_LAST__ = null;
  </script>

  <script src="/build-info.js"></script>
</body>
</html>
